# üîß Firebase Environment Variables Setup Guide

## ‚úÖ Environment Variables Now Used!

Your Talio HRMS now reads Firebase configuration from **environment variables** instead of hardcoded values. This makes it secure and easy to manage different environments (dev, staging, production).

---

## üìã Required Environment Variables

Add these to your `.env.local` (development) or server environment (production):

### Firebase Client Configuration (Public - Browser)
```bash
NEXT_PUBLIC_FIREBASE_API_KEY=your-firebase-api-key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your-project-id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your-sender-id
NEXT_PUBLIC_FIREBASE_APP_ID=your-app-id
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=your-measurement-id (optional)
```

### Firebase Admin SDK (Private - Server Only)
```bash
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYour private key here\n-----END PRIVATE KEY-----\n"
```

### VAPID Key (Web Push)
```bash
NEXT_PUBLIC_FIREBASE_VAPID_KEY=your-vapid-key
```

---

## üîÑ How It Works

### 1. **Client-Side (Browser)**
- **File:** `lib/firebase.js`
- **Reads:** `NEXT_PUBLIC_FIREBASE_*` variables
- **Usage:** Firebase Client SDK, FCM token registration

### 2. **Server-Side (Backend)**
- **File:** `lib/firebase-admin.js`
- **Reads:** `FIREBASE_*` variables (without NEXT_PUBLIC prefix)
- **Usage:** Sending push notifications via Firebase Admin SDK

### 3. **Service Worker**
- **File:** `public/firebase-messaging-sw.js`
- **Generation:** Auto-generated by `scripts/generate-firebase-sw.js`
- **Process:** Environment variables injected at build time

---

## üöÄ Setup Instructions

### Step 1: Create `.env.local` File

Create a new file called `.env.local` in the root of your project:

```bash
# Copy from .env.example
cp .env.example .env.local
```

### Step 2: Add Firebase Configuration

Edit `.env.local` and add your Firebase credentials:

```bash
# ===========================================
# FIREBASE CLOUD MESSAGING (PUSH NOTIFICATIONS)
# ===========================================

# Firebase Client Configuration (from Firebase Console)
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyDEyadwMSwamwG-KeMwzGwZ15UArNdJn-Y
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=talio-e9deb.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=talio-e9deb
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=talio-e9deb.firebasestorage.app
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=241026194465
NEXT_PUBLIC_FIREBASE_APP_ID=1:241026194465:web:b91d15bf73bcf807ad1760
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-XXXXXXXXXX

# Firebase Admin SDK (Get from Firebase Console)
FIREBASE_PROJECT_ID=talio-e9deb
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@talio-e9deb.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYour private key here\n-----END PRIVATE KEY-----\n"

# VAPID Key (from Firebase Console)
NEXT_PUBLIC_FIREBASE_VAPID_KEY=your-vapid-key-here
```

### Step 3: Get Missing Credentials from Firebase Console

Visit https://console.firebase.google.com/ and select your project (`talio-e9deb`):

#### Get Admin SDK Private Key:
1. Go to **Project Settings** (‚öôÔ∏è icon)
2. Go to **Service Accounts** tab
3. Click **Generate New Private Key**
4. Download the JSON file
5. Copy these values to `.env.local`:
   - `private_key` ‚Üí `FIREBASE_PRIVATE_KEY`
   - `client_email` ‚Üí `FIREBASE_CLIENT_EMAIL`
   - `project_id` ‚Üí `FIREBASE_PROJECT_ID`

**‚ö†Ô∏è Important:** Replace `\n` in the private key with actual newlines, or keep it as a string with `\n`.

#### Get VAPID Key:
1. Go to **Project Settings** (‚öôÔ∏è icon)
2. Go to **Cloud Messaging** tab
3. Scroll to **Web Push certificates**
4. Click **Generate Key Pair**
5. Copy the key to `NEXT_PUBLIC_FIREBASE_VAPID_KEY`

### Step 4: Generate Service Worker

The service worker needs to be generated with your environment variables:

```powershell
# Generate the service worker with your Firebase config
npm run generate-sw
```

This will:
- Read Firebase config from `.env.local`
- Generate `public/firebase-messaging-sw.js` with your config injected
- Display a confirmation message

### Step 5: Restart Development Server

```powershell
npm run dev
```

---

## üîß Build Process

The service worker is automatically generated during build:

```powershell
# Development
npm run dev              # Uses existing service worker

# Production Build
npm run build            # Automatically runs generate-sw first
```

The `package.json` build script is updated to:
```json
"build": "npm run generate-sw && SKIP_ENV_VALIDATION=true next build"
```

---

## üìÅ Files That Use Environment Variables

### ‚úÖ Updated to use `.env` variables:

1. **`lib/firebase.js`** - Firebase Client SDK
   - Uses `NEXT_PUBLIC_FIREBASE_*` variables
   - No changes needed - already configured

2. **`lib/firebase-admin.js`** - Firebase Admin SDK
   - Uses `FIREBASE_*` variables
   - No changes needed - already configured

3. **`public/firebase-messaging-sw.js`** - Service Worker
   - Generated from `scripts/generate-firebase-sw.js`
   - Automatically uses environment variables

4. **`scripts/generate-firebase-sw.js`** - Generator Script
   - NEW: Reads `.env.local` and generates service worker
   - Includes fallback to default values

---

## üß™ Testing

### Verify Environment Variables are Loaded:

1. **Check Browser Console:**
```javascript
// In browser DevTools console
console.log('Firebase config check:', {
  hasApiKey: !!process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID
})
```

2. **Check Server Logs:**
```
Look for: [Firebase Admin] Initialized successfully
```

3. **Test Service Worker:**
```javascript
// In browser console
navigator.serviceWorker.getRegistrations().then(regs => {
  console.log('Service Workers:', regs)
})
```

### Test Push Notifications:

```powershell
# Login to the app
# Check console for:
[FirebaseInit] ‚úÖ FCM token obtained
[FirebaseInit] ‚úÖ Token saved to backend
```

---

## üö¢ Production Deployment

### Option 1: Docker (Recommended)

Add environment variables to `docker-compose.yml`:

```yaml
environment:
  # Firebase Client (Public)
  - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
  - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
  - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
  - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
  - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
  - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
  - NEXT_PUBLIC_FIREBASE_VAPID_KEY=${NEXT_PUBLIC_FIREBASE_VAPID_KEY}
  
  # Firebase Admin (Private)
  - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
  - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
  - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
```

Then create `.env` file with actual values (git-ignored).

### Option 2: Server Environment

Set environment variables directly on your server:

```bash
export NEXT_PUBLIC_FIREBASE_API_KEY=your-key
export FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n..."
# ... etc
```

### Option 3: GitHub Secrets (CI/CD)

Add secrets in GitHub repository:
1. Go to Settings ‚Üí Secrets and Variables ‚Üí Actions
2. Add each `FIREBASE_*` variable as a secret
3. Update GitHub Actions workflow to use secrets

---

## üîí Security Best Practices

### ‚úÖ DO:
- ‚úÖ Add `.env.local` to `.gitignore` (already done)
- ‚úÖ Use environment variables for all sensitive data
- ‚úÖ Keep `FIREBASE_PRIVATE_KEY` secret (never commit)
- ‚úÖ Regenerate keys if accidentally exposed

### ‚ùå DON'T:
- ‚ùå Commit `.env.local` or `.env` to git
- ‚ùå Hardcode Firebase credentials in code
- ‚ùå Share private keys in Slack/email
- ‚ùå Use production keys in development

---

## üêõ Troubleshooting

### Service Worker Not Updating?

```powershell
# Regenerate service worker
npm run generate-sw

# Clear browser cache
# DevTools ‚Üí Application ‚Üí Service Workers ‚Üí Unregister
```

### Environment Variables Not Loading?

```powershell
# Check if .env.local exists
ls .env.local

# Verify file has correct format (no spaces around =)
NEXT_PUBLIC_FIREBASE_API_KEY=value  # ‚úÖ Correct
NEXT_PUBLIC_FIREBASE_API_KEY = value  # ‚ùå Wrong
```

### Firebase Admin Not Initializing?

```bash
# Check private key format - should have actual newlines
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC...
-----END PRIVATE KEY-----"

# OR escaped newlines
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvg...\n-----END PRIVATE KEY-----\n"
```

---

## ‚úÖ Verification Checklist

Before deploying to production:

- [ ] `.env.local` file created with all Firebase variables
- [ ] Service worker generated: `npm run generate-sw`
- [ ] Server restarts successfully: `npm run dev`
- [ ] Browser console shows Firebase initialized
- [ ] Server logs show `[Firebase Admin] Initialized successfully`
- [ ] Service worker registered in DevTools
- [ ] FCM token obtained on login
- [ ] Test notification works when app is closed
- [ ] `.env.local` added to `.gitignore`
- [ ] Production environment variables configured

---

## üìö Related Files

- **`.env.example`** - Template with all required variables
- **`lib/firebase.js`** - Client SDK configuration
- **`lib/firebase-admin.js`** - Admin SDK configuration
- **`scripts/generate-firebase-sw.js`** - Service worker generator
- **`public/firebase-messaging-sw.js`** - Auto-generated service worker
- **`package.json`** - Build scripts

---

## üéâ You're All Set!

Your Firebase configuration now uses environment variables, making it:

‚úÖ **Secure** - No hardcoded credentials
‚úÖ **Flexible** - Easy to change per environment
‚úÖ **Production-Ready** - Docker and CI/CD compatible
‚úÖ **Maintainable** - Single source of truth (.env.local)

**Next Steps:**
1. Add Firebase credentials to `.env.local`
2. Run `npm run generate-sw`
3. Start the server: `npm run dev`
4. Test push notifications! üöÄ
