<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Maya</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 120px;
      height: 120px;
      overflow: hidden;
      background: transparent;
      -webkit-app-region: drag;
    }
    .maya-blob-shell {
      position: fixed;
      width: 120px;
      height: 120px;
      display: grid;
      place-items: center;
      pointer-events: auto;
      -webkit-app-region: no-drag;
      cursor: pointer;
    }
    .maya-blob-card {
      position: relative;
      width: 72px;
      height: 72px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .maya-blob-card:hover { transform: scale(1.1); }
    .maya-blob-card:active { transform: scale(0.95); }
    .maya-blob-card::before,
    .maya-blob-card::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid rgba(77, 255, 163, 0.6);
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      pointer-events: none;
    }
    .maya-blob-card.speaking::before { animation: maya-pulse-ring 1.5s ease-out infinite; }
    .maya-blob-card.speaking::after { animation: maya-pulse-ring 1.5s ease-out infinite 0.75s; }
    @keyframes maya-pulse-ring {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
    }
    .maya-blob-card.speaking {
      filter: drop-shadow(0 0 60px rgba(77, 255, 163, 1)) drop-shadow(0 0 30px rgba(77, 255, 200, 0.8));
      animation: maya-blob-speak-pulse 0.6s ease-in-out infinite;
    }
    @keyframes maya-blob-speak-pulse {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.15); }
      50% { transform: scale(1.08); }
      75% { transform: scale(1.2); }
    }
    /* Listening indicator */
    .maya-blob-card.listening {
      filter: drop-shadow(0 0 30px rgba(77, 255, 163, 0.8));
    }
    .maya-blob-card.listening::before {
      animation: maya-listen-pulse 2s ease-in-out infinite;
      opacity: 0.5;
    }
    @keyframes maya-listen-pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
      50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.6; }
    }
    .maya-blob-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="maya-blob-shell" id="mayaBlobShell" title="Click to open MAYA">
    <div class="maya-blob-card" id="mayaBlobCard">
      <canvas class="maya-blob-canvas" id="mayaBlobCanvas"></canvas>
    </div>
  </div>
  <script>
    const card = document.getElementById('mayaBlobCard');
    const canvas = document.getElementById('mayaBlobCanvas');
    const ctx = canvas.getContext('2d');
    const COLORS = [
      { start: 'rgba(77, 255, 163, 0.9)', end: 'rgba(0, 200, 150, 0.3)' },
      { start: 'rgba(100, 220, 255, 0.85)', end: 'rgba(50, 150, 255, 0.25)' },
      { start: 'rgba(139, 93, 255, 0.8)', end: 'rgba(100, 50, 200, 0.2)' },
      { start: 'rgba(255, 180, 100, 0.75)', end: 'rgba(255, 120, 50, 0.2)' }
    ];
    let BLOBS = [];
    const rand = (min, max) => Math.random() * (max - min) + min;
    const noise = (x, y, t) => Math.sin(x * 0.5 + t) * Math.cos(y * 0.5 + t) * 0.5 + 0.5;

    function initBlobs() {
      canvas.width = canvas.height = 72;
      const cx = 36, cy = 36;
      BLOBS = [];
      for (let i = 0; i < 4; i++) {
        const angle = rand(0, Math.PI * 2);
        const dist = rand(0, 8);
        const r = rand(18, 28);
        const homeX = cx + Math.cos(angle) * dist;
        const homeY = cy + Math.sin(angle) * dist;
        BLOBS.push({
          x: homeX, y: homeY, r,
          vx: rand(-0.2, 0.2), vy: rand(-0.2, 0.2),
          hx: homeX, hy: homeY,
          palette: COLORS[i],
          noiseOffset: rand(0, 1000)
        });
      }
    }

    // Smooth blob drawing using bezier curves
    function drawBlob(b, now) {
      const points = 8;
      const angleStep = (Math.PI * 2) / points;
      const grd = ctx.createRadialGradient(b.x, b.y, b.r * 0.1, b.x, b.y, b.r * 1.3);
      grd.addColorStop(0, b.palette.start);
      grd.addColorStop(1, b.palette.end);

      // Calculate all points first
      const pts = [];
      for (let i = 0; i < points; i++) {
        const angle = i * angleStep;
        const n = noise(Math.cos(angle) + b.noiseOffset, Math.sin(angle) + b.noiseOffset, now * 0.0008);
        const offset = b.r * 0.15 * (n - 0.5) * 2;
        pts.push({
          x: b.x + Math.cos(angle) * (b.r + offset),
          y: b.y + Math.sin(angle) * (b.r + offset)
        });
      }

      // Draw smooth bezier curve through points
      ctx.beginPath();
      ctx.moveTo((pts[0].x + pts[points-1].x) / 2, (pts[0].y + pts[points-1].y) / 2);
      for (let i = 0; i < points; i++) {
        const p1 = pts[i];
        const p2 = pts[(i + 1) % points];
        const mx = (p1.x + p2.x) / 2;
        const my = (p1.y + p2.y) / 2;
        ctx.quadraticCurveTo(p1.x, p1.y, mx, my);
      }
      ctx.closePath();
      ctx.fillStyle = grd;
      ctx.fill();
    }

    function animate(now) {
      ctx.clearRect(0, 0, 72, 72);
      for (const b of BLOBS) {
        b.vx += (b.hx - b.x) * 0.012;
        b.vy += (b.hy - b.y) * 0.012;
        b.vx *= 0.97; b.vy *= 0.97;
        b.x += b.vx; b.y += b.vy;
        drawBlob(b, now);
      }
      requestAnimationFrame(animate);
    }

    initBlobs();
    animate(0);

    card.addEventListener('click', async () => {
      if (window.talioDesktop) {
        stopWakeWordListening();
        if (window.talioDesktop.expandWidget) {
          await window.talioDesktop.expandWidget();
        } else {
          await window.talioDesktop.openMayaFromBlob();
        }
      }
    });

    // ============================================
    // Wake word detection with Levenshtein fuzzy matching
    // ============================================
    let recognition = null;
    let isListening = false;
    let retryCount = 0;
    const MAX_RETRIES = 10;
    const FUZZY_THRESHOLD = 2; // Max Levenshtein distance for fuzzy match

    // Wake word variations (exact matches)
    const WAKE_WORDS_EXACT = ['maya', 'maia', 'mya', 'myah', 'maya ai'];
    const WAKE_PREFIXES = ['hey', 'hi', 'ok', 'okay', 'yo', 'hello'];

    // Levenshtein distance for fuzzy matching
    function levenshteinDistance(a, b) {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      
      const matrix = [];
      
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i - 1) === a.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1, // substitution
              matrix[i][j - 1] + 1,     // insertion
              matrix[i - 1][j] + 1      // deletion
            );
          }
        }
      }
      
      return matrix[b.length][a.length];
    }

    // Check if word is close enough to "maya"
    function isFuzzyMaya(word) {
      const normalizedWord = word.toLowerCase().trim();
      
      // Exact match with known variations
      if (WAKE_WORDS_EXACT.includes(normalizedWord)) {
        return true;
      }
      
      // Fuzzy match - allow small edits (typos, mishearings)
      for (const target of WAKE_WORDS_EXACT) {
        if (levenshteinDistance(normalizedWord, target) <= FUZZY_THRESHOLD) {
          return true;
        }
      }
      
      return false;
    }

    function checkWakeWord(transcript) {
      const lower = transcript.toLowerCase().trim();
      const words = lower.split(/\s+/);
      
      console.log('[Maya Blob] Checking transcript:', lower);
      
      // Check for direct wake words with prefix
      for (const prefix of WAKE_PREFIXES) {
        for (const wake of WAKE_WORDS_EXACT) {
          if (lower.includes(`${prefix} ${wake}`)) {
            console.log('[Maya Blob] Found exact match:', `${prefix} ${wake}`);
            return true;
          }
        }
      }
      
      // Check for just "maya" or variations anywhere in the transcript
      for (const word of words) {
        if (isFuzzyMaya(word)) {
          console.log('[Maya Blob] Found fuzzy match for word:', word);
          return true;
        }
      }
      
      // Check pairs of words (in case it's split like "may" "a")
      for (let i = 0; i < words.length - 1; i++) {
        const combined = words[i] + words[i + 1];
        if (isFuzzyMaya(combined)) {
          console.log('[Maya Blob] Found combined fuzzy match:', combined);
          return true;
        }
      }
      
      return false;
    }

    function initWakeWordDetection() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.log('[Maya Blob] Speech recognition not supported');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      recognition.maxAlternatives = 5; // More alternatives for better fuzzy matching

      recognition.onstart = () => {
        console.log('[Maya Blob] Wake word listening started');
        card.classList.add('listening');
      };

      recognition.onresult = async (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          // Check all alternatives
          for (let j = 0; j < result.length; j++) {
            const transcript = result[j].transcript;

            // Check for wake word with fuzzy matching
            if (checkWakeWord(transcript)) {
              console.log('[Maya Blob] Wake word detected!');
              
              // Visual feedback
              card.classList.remove('listening');
              card.classList.add('speaking');

              // Stop listening before opening widget
              stopWakeWordListening();

              // Open Maya widget
              if (window.talioDesktop) {
                if (window.talioDesktop.expandWidget) {
                  await window.talioDesktop.expandWidget();
                } else {
                  await window.talioDesktop.openMayaFromBlob();
                }
              }

              setTimeout(() => {
                card.classList.remove('speaking');
              }, 1000);
              return;
            }
          }
        }
      };

      recognition.onerror = (e) => {
        console.log('[Maya Blob] Speech recognition error:', e.error);
        card.classList.remove('listening');
        
        if (e.error === 'not-allowed') {
          console.log('[Maya Blob] Microphone permission denied');
          // Don't retry on permission error
          return;
        }
        
        if (e.error === 'aborted') {
          // User or system aborted - restart after delay
          if (isListening) {
            setTimeout(() => {
              if (isListening) startWakeWordListening();
            }, 2000);
          }
          return;
        }
        
        // For other errors (no-speech, audio-capture), retry
        if (isListening && retryCount < MAX_RETRIES) {
          retryCount++;
          setTimeout(() => {
            if (isListening) startWakeWordListening();
          }, 1000);
        }
      };

      recognition.onend = () => {
        card.classList.remove('listening');
        
        // Auto-restart if still supposed to be listening
        if (isListening) {
          retryCount = 0;
          setTimeout(() => {
            try {
              if (recognition && isListening) {
                recognition.start();
              }
            } catch (e) {
              console.log('[Maya Blob] Could not restart recognition:', e.message);
              // Try again after a longer delay
              setTimeout(() => {
                if (isListening) startWakeWordListening();
              }, 2000);
            }
          }, 300);
        }
      };
    }

    function startWakeWordListening() {
      if (!recognition) {
        initWakeWordDetection();
      }
      
      if (!recognition) {
        console.log('[Maya Blob] Recognition not available');
        return;
      }
      
      if (isListening) {
        // Already listening
        return;
      }
      
      isListening = true;
      retryCount = 0;
      
      try {
        recognition.start();
        console.log('[Maya Blob] Starting wake word detection');
      } catch (e) {
        console.log('[Maya Blob] Could not start recognition:', e.message);
        isListening = false;
        // Retry after delay
        setTimeout(() => startWakeWordListening(), 1500);
      }
    }

    function stopWakeWordListening() {
      console.log('[Maya Blob] Stopping wake word listening');
      isListening = false;
      card.classList.remove('listening');
      
      try {
        recognition?.stop();
        recognition?.abort();
      } catch (e) {
        // Ignore errors when stopping
      }
    }

    // Initialize and start wake word detection with delay
    setTimeout(() => {
      initWakeWordDetection();
      setTimeout(() => startWakeWordListening(), 500);
    }, 1500);
  </script>
</body>
</html>
