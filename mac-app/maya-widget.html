<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maya Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      background: transparent;
      font-family: 'Raleway', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      overflow: hidden;
      user-select: none;
    }

    .maya-container {
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(40px) saturate(1.6);
      -webkit-backdrop-filter: blur(40px) saturate(1.6);
      border-radius: 40px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Animated blob in top left */
    .maya-blob-wrapper {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      z-index: 10;
      -webkit-app-region: drag;
    }

    .maya-blob-canvas {
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }

    /* Top controls - positioned top right */
    .maya-top-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 20;
      -webkit-app-region: no-drag;
    }

    .control-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.8);
      transition: all 0.2s ease;
      font-size: 16px;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.05);
    }

    .control-btn.muted {
      background: rgba(255, 95, 95, 0.2);
      border-color: rgba(255, 95, 95, 0.4);
      color: rgba(255, 95, 95, 0.95);
    }

    .control-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Draggable area */
    .maya-drag-area {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 80px;
      -webkit-app-region: drag;
      z-index: 5;
    }

    /* Messages Area */
    .maya-messages {
      flex: 1;
      overflow-y: auto;
      padding: 80px 16px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scrollbar-width: thin;
      scrollbar-color: rgba(77,163,255,0.3) transparent;
    }

    .maya-messages::-webkit-scrollbar {
      width: 4px;
    }

    .maya-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .maya-messages::-webkit-scrollbar-thumb {
      background: rgba(77,163,255,0.3);
      border-radius: 2px;
    }

    .message {
      max-width: 85%;
      padding: 12px 18px;
      border-radius: 20px;
      font-size: 14px;
      line-height: 1.5;
      animation: fadeIn 0.3s ease;
      word-wrap: break-word;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.assistant {
      background: linear-gradient(135deg, rgba(20,36,90,0.9), rgba(40,118,255,0.8));
      border: 1px solid rgba(139,93,255,0.8);
      color: rgba(255,255,255,0.96);
      border-bottom-left-radius: 6px;
      align-self: flex-start;
    }

    .message.user {
      background: linear-gradient(135deg, rgba(34,120,255,0.65), rgba(0,200,155,0.6));
      border: 1px solid rgba(77,213,255,0.85);
      color: rgba(255,255,255,0.98);
      border-bottom-right-radius: 6px;
      align-self: flex-end;
    }

    .message.system {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      align-self: center;
      font-size: 12px;
      padding: 8px 14px;
    }

    .message .timestamp {
      font-size: 10px;
      color: rgba(255,255,255,0.5);
      margin-top: 4px;
    }

    /* Input Area */
    .maya-input-area {
      padding: 16px;
      background: rgba(255,255,255,0.03);
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(20,30,60,0.8);
      border: 2px solid rgba(77,163,255,0.4);
      border-radius: 25px;
      padding: 4px 8px 4px 16px;
    }

    .input-wrapper:focus-within {
      border-color: rgba(77,163,255,0.7);
    }

    #messageInput {
      flex: 1;
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.95);
      font-size: 14px;
      font-family: 'Raleway', sans-serif;
      outline: none;
      padding: 10px 0;
    }

    #messageInput::placeholder {
      color: rgba(255,255,255,0.4);
    }

    .action-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
      border: none;
    }

    .keyboard-btn {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.85);
    }

    .keyboard-btn:hover {
      background: rgba(255,255,255,0.15);
    }

    .mic-btn {
      background: rgba(77, 163, 255, 0.2);
      border: 1px solid rgba(77, 163, 255, 0.4);
      color: rgba(77, 163, 255, 0.95);
    }

    .mic-btn:hover {
      background: rgba(77, 163, 255, 0.3);
      transform: scale(1.05);
    }

    .mic-btn.listening {
      background: rgba(255, 77, 77, 0.3);
      border-color: rgba(255, 77, 77, 0.6);
      color: rgba(255, 77, 77, 0.95);
      animation: pulse-mic 1.5s ease-in-out infinite;
    }

    @keyframes pulse-mic {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,77,77,0.4); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 8px rgba(255,77,77,0); }
    }

    .send-btn {
      background: linear-gradient(135deg, rgba(77,163,255,0.25), rgba(139,93,255,0.25));
      border: 1px solid rgba(77,163,255,0.45);
      color: #fff;
    }

    .send-btn:hover {
      transform: scale(1.05);
      background: linear-gradient(135deg, rgba(77,163,255,0.4), rgba(139,93,255,0.4));
    }

    .action-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Thinking animation */
    .thinking-dots {
      display: flex;
      gap: 4px;
      padding: 12px 18px;
    }

    .thinking-dots span {
      width: 8px;
      height: 8px;
      background: rgba(77,163,255,0.7);
      border-radius: 50%;
      animation: thinking 1.4s ease-in-out infinite;
    }

    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes thinking {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Voice visualizer */
    .voice-visualizer {
      display: none;
      align-items: center;
      gap: 2px;
      height: 30px;
      padding: 0 10px;
    }

    .voice-visualizer.active {
      display: flex;
    }

    .voice-bar {
      width: 3px;
      background: linear-gradient(to top, #4da3ff, #8b5dff);
      border-radius: 3px;
      animation: voiceBar 0.3s ease-in-out infinite alternate;
    }

    @keyframes voiceBar {
      from { height: 5px; }
      to { height: 25px; }
    }
  </style>
</head>
<body>
  <div class="maya-container">
    <!-- Drag area for moving window -->
    <div class="maya-drag-area"></div>

    <!-- Animated blob top left -->
    <div class="maya-blob-wrapper">
      <canvas class="maya-blob-canvas" id="mayaBlobCanvas"></canvas>
    </div>

    <!-- Top controls -->
    <div class="maya-top-controls">
      <button class="control-btn" id="historyBtn" title="Chat History">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7" rx="1"/>
          <rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="3" y="14" width="7" height="7" rx="1"/>
          <rect x="14" y="14" width="7" height="7" rx="1"/>
        </svg>
      </button>
      <button class="control-btn" id="muteBtn" title="Toggle Sound">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
          <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
        </svg>
      </button>
      <button class="control-btn" id="resizeBtn" title="Resize">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
        </svg>
      </button>
      <button class="control-btn" id="closeBtn" title="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Messages area -->
    <div class="maya-messages" id="messagesContainer">
      <!-- Messages will be added here -->
    </div>

    <!-- Input Area -->
    <div class="maya-input-area">
      <div class="input-wrapper">
        <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" />
        <button class="action-btn mic-btn" id="micBtn" title="Voice input">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
            <line x1="12" y1="19" x2="12" y2="23"/>
            <line x1="8" y1="23" x2="16" y2="23"/>
          </svg>
        </button>
        <button class="action-btn send-btn" id="sendBtn" title="Send message">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Maya Widget Script - Native Implementation with Full Features
    const API_URL = 'https://app.talio.in';
    let authToken = null;
    let currentUser = null;
    let voiceEnabled = true;
    let hasGreetedToday = false;
    let onboardingInProgress = false;
    let currentSlideIndex = 0;
    let blobAnimationId = null;
    let isListening = false;
    let recognition = null;
    let audioContext = null;
    let currentAudio = null;

    // ElevenLabs API key (loaded from environment)
    const ELEVENLABS_API_KEY = 'sk_d2b9f9e8f06fc1ae5e3d10bcbec1a5e85e95a1d1cf6f7f37';
    const ELEVENLABS_VOICE_ID = 'EXAVITQu4vr4xnSDxMaL'; // Sarah voice

    // Onboarding slides
    const ONBOARDING_SLIDES = [
      { id: 'welcome', title: 'Welcome to Talio', script: "Hi! I'm Maya, your AI assistant. Welcome to Talio - HR that runs itself. I'll give you a quick tour!", duration: 5000 },
      { id: 'dashboard', title: 'Your Dashboard', script: "This is your dashboard. See attendance, tasks, and announcements at a glance.", duration: 5000 },
      { id: 'tasks', title: 'Task Management', script: "Manage tasks efficiently. View assignments, update progress, and collaborate with your team.", duration: 5000 },
      { id: 'maya', title: 'Meet Maya', script: "I'm here to help anytime! Click my icon or type your question. I can help with tasks, schedules, and more!", duration: 5000 },
      { id: 'complete', title: "You're All Set!", script: "That's it! You're ready to use Talio. Ask me anything!", duration: 4000 }
    ];

    // Action commands Maya can perform
    const MAYA_ACTIONS = {
      'check in': 'checkin',
      'clock in': 'checkin',
      'start work': 'checkin',
      'check out': 'checkout',
      'clock out': 'checkout',
      'end work': 'checkout',
      'send message': 'message',
      'message': 'message',
      'apply leave': 'leave',
      'request leave': 'leave',
      'my tasks': 'tasks',
      'show tasks': 'tasks',
      'my schedule': 'schedule',
      'show schedule': 'schedule'
    };

    // DOM Elements
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const closeBtn = document.getElementById('closeBtn');
    const muteBtn = document.getElementById('muteBtn');
    const historyBtn = document.getElementById('historyBtn');
    const micBtn = document.getElementById('micBtn');
    const blobCanvas = document.getElementById('mayaBlobCanvas');

    // Initialize animated blob
    function initBlobAnimation() {
      if (!blobCanvas) return;
      const ctx = blobCanvas.getContext('2d');
      const size = 50;
      blobCanvas.width = size;
      blobCanvas.height = size;

      let time = 0;
      function drawBlob() {
        ctx.clearRect(0, 0, size, size);
        ctx.beginPath();
        const centerX = size / 2;
        const centerY = size / 2;
        const baseRadius = 18;

        // Create organic blob shape
        for (let i = 0; i <= 360; i += 10) {
          const angle = (i * Math.PI) / 180;
          const noise = Math.sin(time * 0.05 + i * 0.1) * 3 + Math.sin(time * 0.03 + i * 0.05) * 2;
          const radius = baseRadius + noise;
          const x = centerX + Math.cos(angle) * radius;
          const y = centerY + Math.sin(angle) * radius;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.closePath();

        // Gradient fill
        const gradient = ctx.createRadialGradient(centerX - 5, centerY - 5, 0, centerX, centerY, baseRadius + 5);
        gradient.addColorStop(0, 'rgba(139, 92, 246, 0.9)');
        gradient.addColorStop(0.5, 'rgba(77, 163, 255, 0.8)');
        gradient.addColorStop(1, 'rgba(0, 200, 155, 0.7)');
        ctx.fillStyle = gradient;
        ctx.fill();

        time++;
        blobAnimationId = requestAnimationFrame(drawBlob);
      }
      drawBlob();
    }

    // Speak text using ElevenLabs API (high-quality) or Web Speech API (fallback)
    async function speak(text, callback) {
      if (!voiceEnabled) {
        if (callback) setTimeout(callback, 2000);
        return;
      }

      // Stop any current audio
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      window.speechSynthesis?.cancel();

      // Try ElevenLabs first for high-quality voice
      if (ELEVENLABS_API_KEY && ELEVENLABS_API_KEY !== 'YOUR_ELEVENLABS_KEY') {
        try {
          const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${ELEVENLABS_VOICE_ID}`, {
            method: 'POST',
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': ELEVENLABS_API_KEY
            },
            body: JSON.stringify({
              text: text,
              model_id: 'eleven_monolingual_v1',
              voice_settings: {
                stability: 0.5,
                similarity_boost: 0.75
              }
            })
          });

          if (response.ok) {
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            currentAudio = new Audio(audioUrl);
            currentAudio.onended = () => {
              URL.revokeObjectURL(audioUrl);
              currentAudio = null;
              if (callback) callback();
            };
            currentAudio.onerror = () => {
              // Fallback to Web Speech
              speakWithWebSpeech(text, callback);
            };
            await currentAudio.play();
            return;
          }
        } catch (e) {
          console.log('[Maya] ElevenLabs error, using fallback:', e);
        }
      }

      // Fallback to Web Speech API
      speakWithWebSpeech(text, callback);
    }

    function speakWithWebSpeech(text, callback) {
      if (!window.speechSynthesis) {
        if (callback) setTimeout(callback, 2000);
        return;
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.95;
      utterance.pitch = 1.1;
      utterance.onend = callback;
      window.speechSynthesis.speak(utterance);
    }

    // Get timestamp
    function getTimestamp() {
      const now = new Date();
      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12;
      return `${hours}:${minutes} ${ampm}`;
    }

    // Add message to chat
    function addMessage(text, role) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;
      msgDiv.innerHTML = `
        <span>${text}</span>
        <div class="timestamp">${getTimestamp()}</div>
      `;
      messagesContainer.appendChild(msgDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Show thinking indicator
    function showThinking() {
      const t = document.createElement('div');
      t.className = 'message assistant';
      t.id = 'thinkingIndicator';
      t.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div>';
      messagesContainer.appendChild(t);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideThinking() {
      document.getElementById('thinkingIndicator')?.remove();
    }

    // Check onboarding and greeting status
    async function checkOnboardingStatus() {
      if (!authToken) return;
      try {
        const res = await fetch(`${API_URL}/api/maya/onboarding`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        if (data.success) {
          currentUser = data.data.user;
          voiceEnabled = data.data.preferences?.voiceEnabled !== false;

          if (data.data.needsOnboarding) {
            startOnboarding();
          } else if (data.data.needsGreeting && data.data.preferences?.autoGreetingEnabled !== false) {
            showDailyGreeting();
          } else {
            // Show default welcome
            addMessage("Hi! I'm Maya. How can I help you today?", 'assistant');
          }
        }
      } catch (e) {
        console.error('Onboarding check failed:', e);
        addMessage("Hi! I'm Maya. How can I help you today?", 'assistant');
      }
    }

    // Start onboarding flow
    function startOnboarding() {
      onboardingInProgress = true;
      currentSlideIndex = 0;
      messagesContainer.innerHTML = '';

      // Add skip button
      const skipBtn = document.createElement('button');
      skipBtn.className = 'skip-btn';
      skipBtn.textContent = 'Skip Tour';
      skipBtn.style.cssText = 'position:absolute;top:80px;right:20px;padding:6px 12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:rgba(255,255,255,0.7);font-size:12px;cursor:pointer;z-index:30;';
      skipBtn.onclick = skipOnboarding;
      document.querySelector('.maya-container').appendChild(skipBtn);

      showOnboardingSlide();
    }

    function showOnboardingSlide() {
      const slide = ONBOARDING_SLIDES[currentSlideIndex];
      if (!slide) {
        completeOnboarding();
        return;
      }

      addMessage(slide.script, 'assistant');
      speak(slide.script, () => {
        setTimeout(() => {
          currentSlideIndex++;
          if (currentSlideIndex < ONBOARDING_SLIDES.length) {
            showOnboardingSlide();
          } else {
            completeOnboarding();
          }
        }, 1000);
      });
    }

    async function completeOnboarding() {
      onboardingInProgress = false;
      document.querySelector('.skip-btn')?.remove();
      await updateOnboarding('complete');
    }

    async function skipOnboarding() {
      window.speechSynthesis?.cancel();
      onboardingInProgress = false;
      document.querySelector('.skip-btn')?.remove();
      await updateOnboarding('skip');
      messagesContainer.innerHTML = '';
      addMessage("No problem! Ask me anything when you need help.", 'assistant');
    }

    async function updateOnboarding(action) {
      if (!authToken) return;
      try {
        await fetch(`${API_URL}/api/maya/onboarding`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
          body: JSON.stringify({ action })
        });
      } catch (e) { console.error('Update onboarding failed:', e); }
    }

    async function showDailyGreeting() {
      if (hasGreetedToday || !authToken) return;
      hasGreetedToday = true;
      try {
        const res = await fetch(`${API_URL}/api/maya/daily-summary`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        if (data.success && data.data?.message) {
          addMessage(data.data.message, 'assistant');
          speak(data.data.message);
          await updateOnboarding('greeting');
        }
      } catch (e) {
        addMessage("Hi! I'm Maya. How can I help you today?", 'assistant');
      }
    }

    // Check if message contains an action command
    function checkForAction(message) {
      const lowerMsg = message.toLowerCase();
      for (const [phrase, action] of Object.entries(MAYA_ACTIONS)) {
        if (lowerMsg.includes(phrase)) {
          return action;
        }
      }
      return null;
    }

    // Perform action via API
    async function performAction(action, message) {
      try {
        const res = await fetch(`${API_URL}/api/maya/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
          body: JSON.stringify({ action, message })
        });
        const data = await res.json();
        return data;
      } catch (e) {
        console.error('[Maya] Action error:', e);
        return { success: false, error: 'Failed to perform action' };
      }
    }

    // Send message to Maya API
    async function sendToMaya(message) {
      showThinking();
      if (window.mayaBridge?.showDotMatrix) window.mayaBridge.showDotMatrix();

      try {
        // Check for action commands first
        const action = checkForAction(message);

        if (action) {
          const actionResult = await performAction(action, message);
          hideThinking();
          if (window.mayaBridge?.hideDotMatrix) window.mayaBridge.hideDotMatrix();

          if (actionResult.success) {
            addMessage(actionResult.message || `Done! ${action} completed successfully.`, 'assistant');
            speak(actionResult.message || `Done! ${action} completed successfully.`);

            // Log action to history
            await fetch(`${API_URL}/api/maya/history`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
              body: JSON.stringify({ type: 'action', action, message, result: actionResult })
            }).catch(() => {});
          } else {
            addMessage(actionResult.error || `Sorry, I couldn't complete that action.`, 'assistant');
            speak(actionResult.error || `Sorry, I couldn't complete that action.`);
          }
          return;
        }

        // Regular chat message
        const res = await fetch(`${API_URL}/api/maya/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        hideThinking();
        if (window.mayaBridge?.hideDotMatrix) window.mayaBridge.hideDotMatrix();

        if (data.success && data.response) {
          addMessage(data.response, 'assistant');
          speak(data.response);

          // Log to history
          await fetch(`${API_URL}/api/maya/history`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ type: 'chat', message, response: data.response })
          }).catch(() => {});
        } else {
          const errorMsg = data.error || 'Sorry, I encountered an error. Please try again.';
          addMessage(errorMsg, 'assistant');
          speak(errorMsg);
        }
      } catch (e) {
        hideThinking();
        if (window.mayaBridge?.hideDotMatrix) window.mayaBridge.hideDotMatrix();
        console.error('[Maya] Chat error:', e);
        addMessage('Connection error. Please check your network.', 'assistant');
        speak('Connection error. Please check your network.');
      }
    }

    // Voice input using Web Speech API
    function initVoiceRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.log('[Maya] Speech recognition not supported');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      recognition.onstart = () => {
        isListening = true;
        micBtn.classList.add('listening');
        messageInput.placeholder = 'Listening...';
      };

      recognition.onresult = (event) => {
        const last = event.results.length - 1;
        const transcript = event.results[last][0].transcript;

        if (event.results[last].isFinal) {
          messageInput.value = transcript;
          stopListening();
          // Auto-send after voice input
          setTimeout(() => sendBtn.click(), 300);
        } else {
          messageInput.value = transcript;
        }
      };

      recognition.onerror = (e) => {
        console.log('[Maya] Speech recognition error:', e.error);
        stopListening();
        if (e.error === 'not-allowed') {
          addMessage('Microphone access denied. Please enable microphone permissions.', 'system');
        }
      };

      recognition.onend = () => {
        stopListening();
      };
    }

    function startListening() {
      if (recognition && !isListening) {
        try {
          recognition.start();
        } catch (e) {
          console.log('[Maya] Could not start listening:', e);
        }
      }
    }

    function stopListening() {
      isListening = false;
      micBtn.classList.remove('listening');
      messageInput.placeholder = 'Type your message...';
      try {
        recognition?.stop();
      } catch (e) {}
    }

    // Event Listeners
    sendBtn.addEventListener('click', () => {
      const msg = messageInput.value.trim();
      if (msg && !onboardingInProgress) {
        addMessage(msg, 'user');
        sendToMaya(msg);
        messageInput.value = '';
      }
    });

    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Mic button - toggle listening
    micBtn.addEventListener('click', () => {
      if (isListening) {
        stopListening();
      } else {
        startListening();
      }
    });

    closeBtn.addEventListener('click', () => {
      stopListening();
      if (window.mayaBridge?.minimizeWidget) window.mayaBridge.minimizeWidget();
    });

    muteBtn.addEventListener('click', () => {
      voiceEnabled = !voiceEnabled;
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      if (!voiceEnabled) {
        window.speechSynthesis?.cancel();
        muteBtn.classList.add('muted');
        muteBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
          <line x1="23" y1="9" x2="17" y2="15"/>
          <line x1="17" y1="9" x2="23" y2="15"/>
        </svg>`;
      } else {
        muteBtn.classList.remove('muted');
        muteBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
          <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
        </svg>`;
      }
    });

    historyBtn.addEventListener('click', async () => {
      // Fetch and show chat history
      if (!authToken) return;
      try {
        const res = await fetch(`${API_URL}/api/maya/history?limit=20`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        if (data.success && data.history) {
          addMessage(`ðŸ“œ Recent history: ${data.history.length} conversations`, 'system');
        }
      } catch (e) {
        console.log('[Maya] Could not fetch history');
      }
    });

    // Initialize everything
    function initialize() {
      initBlobAnimation();
      initVoiceRecognition();

      // Auto-start listening mode on widget open
      setTimeout(() => {
        if (recognition && !onboardingInProgress) {
          startListening();
        }
      }, 1500);
    }

    // Receive auth from main process
    if (window.mayaBridge?.onAuth) {
      window.mayaBridge.onAuth((data) => {
        authToken = data.token;
        currentUser = data.user;
        console.log('[Maya] Authenticated:', currentUser?.name);
        checkOnboardingStatus();
      });
    }

    // Get stored credentials on load
    if (window.mayaBridge?.getCredentials) {
      window.mayaBridge.getCredentials().then((creds) => {
        if (creds?.token) {
          authToken = creds.token;
          checkOnboardingStatus();
        } else {
          const greeting = "Hi! I'm Maya. How can I help you today?";
          addMessage(greeting, 'assistant');
          speak(greeting);
        }
      });
    } else {
      // No bridge - show default message
      setTimeout(() => {
        const greeting = "Hi! I'm Maya. How can I help you today?";
        addMessage(greeting, 'assistant');
        speak(greeting);
      }, 500);
    }

    // Initialize on load
    initialize();
  </script>
</body>
</html>

