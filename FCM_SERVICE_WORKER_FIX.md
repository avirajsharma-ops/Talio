# Firebase Cloud Messaging (FCM) Service Worker Fix

## Problem Analysis

### Issues Identified:

1. **Multiple Service Worker Conflict**
   - Workbox SW (`sw.js`) auto-generated by `next-pwa`
   - Firebase Messaging SW (`firebase-messaging-sw.js`)
   - OneSignal SW (`OneSignalSDKWorker.js`) - not currently used
   - **Only ONE service worker can control a scope at a time**

2. **Workbox Precaching 404 Error**
   - Workbox trying to precache `/_next/app-build-manifest.json` which returns 404
   - This delays/blocks other SW registrations
   - Causes `bad-precaching-response` errors

3. **Firebase SW Registration Timeout**
   - Firebase expects SW to register within 10 seconds
   - Workbox registration blocks Firebase registration
   - Results in: `messaging/failed-service-worker-registration`

4. **Service Worker Scope Conflict**
   - When Workbox registers first at scope `/`, Firebase can't register
   - Browser only allows one SW per scope

## Solution Implemented

### Strategy: Disable Workbox PWA, Use Firebase SW Only

We disabled the Workbox PWA service worker and use only the Firebase Messaging service worker. This eliminates all conflicts.

### Changes Made:

#### 1. **Disabled next-pwa** (`next.config.js`)
```javascript
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  disable: true, // ✅ Disabled to avoid conflicts with Firebase SW
  runtimeCaching: [...]
})
```

**Why**: Prevents Workbox from generating and registering `sw.js`, eliminating the conflict.

#### 2. **Enhanced Firebase Messaging SW** (`public/firebase-messaging-sw.js`)
- Added proper error handling for Firebase initialization
- Improved logging for debugging
- Added service worker lifecycle events (install, activate)
- Handles background messages, notification clicks, and notification close events

**Key Features**:
- ✅ Initializes Firebase Messaging
- ✅ Handles background push notifications
- ✅ Handles notification clicks with URL navigation
- ✅ Proper service worker lifecycle management

#### 3. **Manual Service Worker Registration** (`components/FirebaseInit.js`)
Added explicit service worker registration before FCM token request:

```javascript
// Register service worker first
if ('serviceWorker' in navigator) {
  const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
    scope: '/',
    updateViaCache: 'none'
  })
  await navigator.serviceWorker.ready
}
```

**Why**: Ensures the Firebase SW is registered and ready before requesting FCM tokens.

#### 4. **Updated FCM Token Request** (`lib/firebase.js`)
Enhanced `requestFCMToken()` to:
- Wait for service worker to be ready
- Pass service worker registration to `getToken()`
- Handle service worker errors gracefully
- Fallback to default registration if needed

```javascript
const registration = await navigator.serviceWorker.ready
const token = await getToken(messaging, { 
  vapidKey,
  serviceWorkerRegistration: registration
})
```

## How It Works Now

### Initialization Flow:

1. **Page Load**
   - `FirebaseInit` component mounts
   - Registers `/firebase-messaging-sw.js` service worker
   - Waits for service worker to be ready

2. **FCM Token Request**
   - Requests notification permission
   - Gets FCM token using the registered service worker
   - Saves token to backend

3. **Background Notifications**
   - Firebase SW receives push messages
   - Shows notifications using `self.registration.showNotification()`
   - Handles notification clicks and navigation

4. **Foreground Notifications**
   - Firebase SDK receives messages via `onMessage()`
   - App shows in-app notifications via Socket.IO
   - Browser notifications shown only when app is hidden

## Benefits

✅ **No More Service Worker Conflicts** - Only one SW registered  
✅ **Reliable FCM Token Generation** - SW ready before token request  
✅ **No 404 Precaching Errors** - Workbox disabled  
✅ **Fast Registration** - No 10-second timeout  
✅ **Proper Error Handling** - Detailed logging for debugging  
✅ **Clean Architecture** - Single responsibility per SW  

## Testing

### To Verify the Fix:

1. **Open DevTools Console**
   - Should see: `[FirebaseInit] ✅ Service worker registered`
   - Should see: `[SW] Firebase Messaging initialized successfully`
   - Should see: `[FirebaseInit] ✅ FCM token obtained`

2. **Check Service Workers** (DevTools > Application > Service Workers)
   - Should see only `/firebase-messaging-sw.js` registered
   - Status should be "activated and running"

3. **Test Notifications**
   - Request notification permission
   - Send test notification from backend
   - Should receive notification when app is in background

### Expected Console Output:
```
[FirebaseInit] Starting initialization...
[FirebaseInit] Registering service worker...
[SW] Combined Service Worker starting...
[SW] Firebase Messaging initialized successfully
[FirebaseInit] ✅ Service worker registered: /
[FirebaseInit] ✅ Service worker ready
[FirebaseInit] User logged in: 123456
[Firebase] Notification permission: granted
[Firebase] Service worker ready: /
[Firebase] FCM token obtained: <token>
[FirebaseInit] ✅ FCM token obtained
[Firebase] Token saved to backend: { success: true }
```

## Files Modified

1. `next.config.js` - Disabled next-pwa
2. `public/firebase-messaging-sw.js` - Enhanced Firebase SW
3. `components/FirebaseInit.js` - Added manual SW registration
4. `lib/firebase.js` - Updated token request with SW registration

## Rollback Plan

If issues occur, you can re-enable Workbox PWA by changing `next.config.js`:

```javascript
disable: process.env.NODE_ENV === 'development', // Only disable in dev
```

However, this will bring back the service worker conflicts.

