/**
 * Generate Firebase Messaging Service Worker with Environment Variables
 * This script creates the service worker file with Firebase config injected from .env
 * Run this as part of the build process: npm run generate-sw
 */

const fs = require('fs')
const path = require('path')

// Try to load environment variables
try {
    require('dotenv').config({ path: path.join(__dirname, '..', '.env.local') })
} catch (error) {
    console.warn('âš ï¸  .env.local not found, using default values')
}

// Get Firebase config from environment variables with fallbacks
const firebaseConfig = {
    apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY || 'AIzaSyDEyadwMSwamwG-KeMwzGwZ15UArNdJn-Y',
    authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN || 'talio-e9deb.firebaseapp.com',
    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || 'talio-e9deb',
    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET || 'talio-e9deb.firebasestorage.app',
    messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID || '241026194465',
    appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID || '1:241026194465:web:b91d15bf73bcf807ad1760',
}

// Service Worker Template
const swTemplate = `// Combined Service Worker: PWA + Firebase Cloud Messaging
// This file handles both PWA caching (Workbox) and FCM push notifications
// AUTO-GENERATED - Do not edit directly! Generated by scripts/generate-firebase-sw.js

console.log('[SW] Combined Service Worker starting...')

// Import Firebase scripts for Cloud Messaging
importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js')
importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js')

// Firebase configuration - Talio HRMS Project
// Configuration loaded from environment variables at build time
const firebaseConfig = ${JSON.stringify(firebaseConfig, null, 2)}

// Initialize Firebase
let messaging = null
try {
  firebase.initializeApp(firebaseConfig)
  messaging = firebase.messaging()
  console.log('[SW] Firebase Messaging initialized successfully')
} catch (error) {
  console.error('[SW] Firebase initialization error:', error)
}

// Handle background messages
if (messaging) {
  messaging.onBackgroundMessage((payload) => {
    console.log('[SW] Background FCM message received:', payload)

    const notificationTitle = payload.notification?.title || 'Talio HRMS'
    const notificationOptions = {
      body: payload.notification?.body || 'You have a new notification',
      icon: payload.notification?.icon || '/icons/icon-192x192.png',
      badge: '/icons/icon-96x96.png',
      tag: payload.data?.tag || 'talio-notification',
      data: {
        url: payload.data?.clickAction || payload.data?.click_action || payload.fcmOptions?.link || '/dashboard',
        ...payload.data
      },
      vibrate: [200, 100, 200],
      requireInteraction: false,
      silent: false, // Use device's default notification sound
      renotify: true,
      timestamp: Date.now()
    }

    // Add image if available
    if (payload.notification?.image) {
      notificationOptions.image = payload.notification.image
    }

    // Show notification - browser/Android will automatically play default notification sound
    console.log('[SW] Showing notification:', notificationTitle)
    return self.registration.showNotification(notificationTitle, notificationOptions)
  })
}

// Handle notification click
self.addEventListener('notificationclick', (event) => {
  console.log('[Firebase SW] Notification clicked:', event)

  event.notification.close()

  if (event.action === 'close') {
    return
  }

  // Get the URL from notification data
  const urlToOpen = event.notification.data?.url || '/dashboard'

  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true })
      .then((clientList) => {
        // Check if there's already a window open
        for (const client of clientList) {
          if (client.url.includes(urlToOpen) && 'focus' in client) {
            return client.focus()
          }
        }

        // If no window is open, open a new one
        if (clients.openWindow) {
          return clients.openWindow(urlToOpen)
        }
      })
  )
})

// Handle notification close
self.addEventListener('notificationclose', (event) => {
  console.log('[Firebase SW] Notification closed:', event)
})

// Service worker activation
self.addEventListener('activate', (event) => {
  console.log('[Firebase SW] Service worker activated')
  event.waitUntil(clients.claim())
})

// Service worker installation
self.addEventListener('install', () => {
  console.log('[SW] Service worker installed')
  self.skipWaiting()
})
`

// Write the service worker file
const swOutputPath = path.join(__dirname, '..', 'public', 'firebase-messaging-sw.js')
fs.writeFileSync(swOutputPath, swTemplate)

console.log('âœ… Firebase Messaging Service Worker generated successfully!')
console.log('ğŸ“ Configuration injected:')
console.log(`   - API Key: ${firebaseConfig.apiKey.substring(0, 20)}...`)
console.log(`   - Project ID: ${firebaseConfig.projectId}`)
console.log(`   - App ID: ${firebaseConfig.appId}`)
console.log(`   - Messaging Sender ID: ${firebaseConfig.messagingSenderId}`)
console.log(`\nğŸ“„ File created: public/firebase-messaging-sw.js`)
console.log('')

